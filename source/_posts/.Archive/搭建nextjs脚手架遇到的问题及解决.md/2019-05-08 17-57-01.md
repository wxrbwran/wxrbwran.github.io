---
title: 搭建nextjs脚手架遇到的问题及解决
date: 2019-05-08 17:44:02
tags: 
    - react
    - ssr
---

### 问题
**nextjs**是react的ssr后端渲染框架，在搭建过程中遇到一些问题，再次记录下来。
1. 使用antd ui框架，同时使用scss预处理器，在next.config.js中同时使用~~with-less~~和~~with-sass~~,并没有达到预期中的结果，scss文件解析正常，antd样式全丢。
2. 实现antd的按需加载
3. 使用typescript，如何配置。
<!--more-->
### 解决方法

1. 在next官网上告诉我们的with-sass,with-less,with-typescript串联的方法并不管用，需要自己新建next.config.js文件，配置loader
```js
const path = require('path');
const withTypescript = require('@zeit/next-typescript');
const cssLoaderConfig = require('@zeit/next-css/css-loader-config');
const lessToJS = require('less-vars-to-js');
const fs = require('fs');
const themeVariables = lessToJS(
  fs.readFileSync(path.resolve(__dirname, './assets/antd-custom.less'), 'utf8'),
);

// fix: prevents error when .less files are required by node
if (typeof require !== 'undefined') {
  require.extensions['.less'] = (file) => {};
}

module.exports = withTypescript({
  pageExtensions: ['jsx', 'js', 'ts', 'tsx'],
  webpack(config, options) {
    if (!options.defaultLoaders) {
      throw new Error(
        'This plugin is not compatible with Next.js versions below 5.0.0 https://err.sh/next-plugins/upgrade',
      );
    }
    const { dev, defaultLoaders, isServer } = options;
    // const nextConfig = {};
    const {
      cssModules,
      cssLoaderOptions,
      postcssLoaderOptions,
      lessLoaderOptions = {},
    } = {};

    console.log('options.defaultLoaders', defaultLoaders);

    config.resolve.extensions.push('.ts', '.tsx');
    config.resolve.alias = Object.assign({}, config.resolve.alias, {
      '@utils': path.resolve(__dirname, 'utils'),
      '@assets': path.resolve(__dirname, 'assets'),
      '@pages': path.resolve(__dirname, 'pages'),
      '@components': path.resolve(__dirname, 'components'),
      '@services': path.resolve(__dirname, 'services'),
    });

    defaultLoaders.less = cssLoaderConfig(config, {
      extensions: ['less'],
      cssModules,
      cssLoaderOptions,
      postcssLoaderOptions,
      dev,
      isServer,
      loaders: [
        {
          loader: 'less-loader',
          options: lessLoaderOptions,
        },
      ],
    });

    config.module.rules.push({
      test: /\.less$/,
      exclude: /node_modules/,
      use: options.defaultLoaders.less,
    });

    // 我们禁用了antd的cssModules
    config.module.rules.push({
      test: /\.less$/,
      include: /node_modules/,
      use: cssLoaderConfig(config, {
        extensions: ['less'],
        cssModules: false,
        cssLoaderOptions: {},
        dev,
        isServer,
        loaders: [
          {
            loader: 'less-loader',
            options: {
              javascriptEnabled: true,
              modifyVars: themeVariables,
            },
          },
        ],
      }),
    });

    config.module.rules.push({
      test: /\.scss$/,
      exclude: /node_modules/,
      use: cssLoaderConfig(config, {
        extensions: ['scss'],
        cssModules: true,
        cssLoaderOptions: {
          importLoaders: 1,
          localIdentName: '[local]_[hash:base64:6]',
        },
        dev,
        isServer,
        loaders: [
          {
            loader: 'sass-loader',
            options: {
              data: '@import "_base.scss";',
              includePaths: [path.resolve('./styles')],
            },
          },
        ],
      }),
    });
    if (dev) {
      config.module.rules.push({
        test: /\.(ts|tsx|js|jsx)$/,
        enforce: 'pre',
        exclude: /node_modules/,
        options: {
          configFile: path.resolve('.eslintrc'),
          eslint: {
            configFile: path.resolve(__dirname, '.eslintrc'),
          },
          fix: true,
        },
        loader: 'eslint-loader',
      });
      config.devtool = 'cheap-module-eval-source-map';
    }

    return config;
  },
});
```
这样