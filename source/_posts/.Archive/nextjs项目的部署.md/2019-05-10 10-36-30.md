---
title: nextjs项目的部署
date: 2019-05-10 10:11:05
tags: nextjs
---
## 常规部署
### Export静态资源
提到发布页面，就不能不提到Next提供的这个功能了，前面也减少过，但是很简单的介绍的，正好这个Demo全是静态页，没有任何数据获取操作～
Export的功能就是通过配置，将对应的pages下的路由页面导出成静态html文件。
<!--more-->

### export 配置
```js
// package.json
"scripts": {
    "dev": "NODE_ENV=development node server.ts -p 3006",
    "prod": "NODE_ENV=production node server.ts -p 3006",
    "start": "NODE_ENV=production node server.ts",
    "build": "next build",
    // 新增export命令
    "export": "yarn build && next export",
 }
 
 // next.config.js
 exportPathMap: async function (defaultPathMap) {
    return {
      '/': { page: '/' },
      '/user': { page: '/user' },
      '/user/list': { page: '/user/list' },
      '/user/detail': { page: '/user/detail' }
    }
  }
```

### serve启动
我们通过export命令，会将项目生成一个静态资源文件夹out，如图所示：
![](./next1.png)

> 其实这个就跟我们正常的SPA应用例如create-react-app生成的build文件夹很像，里面有一个index.html。同理，我们可以使用serve来进行启动～
```js
1.安装serve
yarn add serve

2.增加启动命令
"scripts": {
    ...
    // 增加
    "static": "yarn export && serve out"
  }

3.运行命令
yarn static
```
运行后控制台截图，以及访问localhost:5000/
![](./next2.png)
## 生产环境部署
> 官方的代码就是将NODE_ENV设置成production即可，就是生产环境～，这里说明一下正好有人问过，如果是windows环境，命令应该变成"prod": "set NODE_ENV=production && node server.js"
> 即： yarn build

## PM2实现高级部署上线
- 第一步：配置文件
```js
module.exports = {
  apps: [
    {
      // 指定解释器
      interpreter: './node_modules/.bin/ts-node',
      // 解释器参数 -P 表示项目路径，会自动使用项目的 tsconfig.json
      interpreter_args: '-P ./ -r tsconfig-paths/register',
      name: 'next', // 应用名称
      script: './server.ts', // 启动文件地址
      cwd: './', // 当前工作路径
      watch: [
        // 监控变化的目录，一旦变化，自动重启
        '.next',
      ],
      ignore_watch: [
        // 从监控目录中排除
        'node_modules',
        'logs',
        'static',
      ],
      instances: 2, // 负载均衡，启动2个实例
      node_args: '--harmony', // node的启动模式
      env: {
        NODE_ENV: 'production', // 设置运行环境，此时process.env.NODE_ENV的值就是development
        port: 3006
      },
      env_production: {
        NODE_ENV: 'production',
        port: 5555
      },
      out_file: './logs/out.log', // 普通日志路径
      error_file: './logs/err.log', // 错误日志路径
      merge_logs: true,
      log_date_format: 'YYYY-MM-DD HH:mm Z',
    },
  ],
};

```
- 第二步：部署服务
```
# 运行命令
$ pm2 start pm2.config.js --env production
```
![](./next2.png)
如上图所示，我这边开发环境是3006端口，生产环境是5555端口，使用pm2部署服务以后，访问项目都是正常的，包括API服务。并且pm2还为我们提供日志以及监控功能，详细如下图：

系统所有的控制台输出日志：
## now 部署

